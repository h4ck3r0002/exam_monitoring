{% extends 'base.html' %}
{% load static %}
{% block title %} {{exam.title}} {% endblock title %}

{% block content %}

<div class="container p-3">
    <div class="">
        <input type="hidden" name="exam_id" id="exam_id" value="{{exam.id}}">
        <h2 style="color: #FFBF61;font-size: 28px;">{{ exam.title }}</h2>
        <p>Số lượng câu hỏi: {{counter}}</p>
        <p style="display: flex;align-items: center;justify-content: space-between;"><span style="color: #222;font-weight: 700;font-size: 18px;">Player: {{request.user.username}}</span><span id="countdown" style="display: block;font-size: 18px;font-weight: 700;color: #0D92F4;">15:00</span></p>
        <form method="post" action="{% url 'exam' exam.id %}">
            {% csrf_token %}
            <div class="slider">
                {% for question in exam.question_set.all %}
                    <div class="slide">
                        <p>Câu hỏi: {{ question.question_text }}</p>

                        <input type="hidden" name="question_{{ question.id }}" value="">
                        {% for answer in question.answer_set.all %}
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="question_{{ question.id }}" value="{{ answer.id }}">
                                <label class="form-check-label">
                                    {{ answer.answer_text }}
                                </label>
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
            
            <div class="controls">
                <button type="button" class="btn btn-dark" onclick="prevSlide()">
                    Prev
                </button>
                <button type="button" class="btn btn-primary" onclick="nextSlide()">
                    Next
                </button>
                <button class="btn btn-success" type="submit">Nộp bài</button>
                <button type="button" onclick="window.location.href = '/'" class="btn btn-dark">Trang chủ</button>
            </div>
        </form>
    </div>
    
    <video style="position: absolute; top: 50px;right: 100px;width: 200px;height: 200px;" id="videoElement" autoplay muted></video>

    <script>
        // Countdown timer (15 minutes)
        let timeLeft = 15 * 60; // 15 minutes in seconds
        const countdownElement = document.getElementById("countdown");

        const timerInterval = setInterval(() => {
            let minutes = Math.floor(timeLeft / 60);
            let seconds = timeLeft % 60;
            seconds = seconds < 10 ? '0' + seconds : seconds;
            countdownElement.innerHTML = `${minutes}:${seconds}`;

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                document.getElementById("examForm").submit(); // Auto-submit the form when time runs out
            }
            timeLeft -= 1;
        }, 1000);
    
        
        let mediaRecorder;
        let recordedChunks = [];

        async function startVideoRecording() {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            const videoElement = document.getElementById('videoElement');
            videoElement.srcObject = stream;

            mediaRecorder = new MediaRecorder(stream, {
                mimeType: 'video/webm;codecs=vp9',
            });

            // Khi có dữ liệu video mới, thêm vào mảng `recordedChunks`
            mediaRecorder.ondataavailable = function(event) {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            mediaRecorder.start(); // Bắt đầu ghi
        }

        // Gửi video khi người dùng nhấn submit
        async function uploadRecordedVideo() {
            // Dừng ghi và tạo Blob từ các đoạn video đã ghi
            mediaRecorder.stop();
            const blob = new Blob(recordedChunks, { type: 'video/webm' });

            // Tạo FormData và thêm video Blob vào
            const formData = new FormData();
            formData.append('video_recording', blob, 'recorded_video.webm');

            const examId = document.getElementById('exam_id').value;

            await fetch(`/monitoring/upload_video/${examId}`, {
                method: 'POST',
                body: formData,
            }).then(response => {
                if (response.ok) {
                    console.log("Video uploaded successfully");
                } else {
                    console.error("Failed to upload video");
                }
            });
        }

        // Khi submit form thì gọi uploadRecordedVideo và gửi form
        document.querySelector("form").onsubmit = async function(event) {
            event.preventDefault(); // Ngăn form submit mặc định
            await uploadRecordedVideo(); // Gửi video lên server
            this.submit(); // Sau khi gửi xong, submit form
        };

        startVideoRecording(); // Bắt đầu ghi khi tải trang



    </script>
</div>

{% endblock content %}